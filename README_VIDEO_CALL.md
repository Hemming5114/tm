# 视频通话功能实现

## 功能概述

已在用户详情页面（`user_detail_page.dart`）实现完整的模拟视频通话功能，支持：

### 🎥 核心功能
- **模拟视频通话界面**：使用对方头像作为背景，显示真实的摄像头预览窗口
- **摄像头控制**：支持开关摄像头、前后摄像头切换
- **后台音乐播放**：拨打过程中循环播放背景音乐
- **自动挂断**：1分钟后自动提示"对方未接通"
- **通话记录**：自动在聊天记录中插入通话状态消息
- **后台播放支持**：保持屏幕常亮，支持后台音频播放

### 🎯 用户交互
- **启动通话**：在用户详情页点击"视频"按钮
- **控制界面**：点击屏幕显示/隐藏控制按钮（3秒后自动隐藏）
- **挂断通话**：点击红色挂断按钮或使用返回键
- **摄像头操作**：
  - 切换前后摄像头
  - 开关摄像头（关闭时显示占位图标）
  - 小窗口显示自己的摄像头画面

### 📱 权限和配置

#### iOS权限（Info.plist）
```xml
<key>NSCameraUsageDescription</key>
<string>应用需要使用相机进行头像拍摄和视频通话功能</string>
<key>NSMicrophoneUsageDescription</key>
<string>视频通话功能需要使用麦克风</string>
```

#### Android权限（AndroidManifest.xml）
```xml
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
```

### 🎵 音频效果
- 使用震动反馈模拟拨打铃声效果
- 每2秒震动一次，直到通话结束或挂断
- 无需额外的音频文件资源

### 📦 依赖项
```yaml
dependencies:
  camera: ^0.10.5+5        # 摄像头功能
  wakelock: ^0.4.0         # 保持屏幕常亮
```

### 🔄 工作流程

1. **启动通话**
   - 初始化摄像头（前置摄像头）
   - 开始震动模拟拨打音效（每2秒一次）
   - 启动1分钟计时器
   - 保持屏幕常亮

2. **通话界面**
   - 全屏显示对方头像背景
   - 右上角显示摄像头预览小窗口
   - 顶部显示对方姓名和"正在呼叫中..."
   - 底部控制栏（3秒后自动隐藏）

3. **结束通话**
   - 停止震动音效
   - 释放摄像头资源
   - 取消屏幕常亮
   - 插入通话记录到聊天消息
   - 返回上一页

### 💬 聊天记录集成
- 通话结束后自动在与该用户的聊天记录中插入系统消息
- 主动挂断：显示"视频通话已结束"
- 超时未接：显示"视频通话 对方未接通"

### 🎨 界面设计
- **背景**：对方头像，带半透明黑色遮罩
- **摄像头窗口**：120x160像素，圆角白色边框，右上角位置
- **控制按钮**：圆形按钮，半透明背景，白色图标
- **挂断按钮**：红色背景，60像素大小
- **状态指示**：白色文字，带阴影效果

### 🚀 使用方法
1. 在用户详情页面点击"视频"按钮
2. 系统会请求摄像头权限（首次使用）
3. 进入视频通话界面，开始震动模拟拨打音效
4. 点击屏幕可显示/隐藏控制按钮
5. 使用各种控制按钮操作摄像头
6. 点击挂断按钮或等待1分钟自动结束

### 🔧 技术特性
- **生命周期管理**：正确处理应用前后台切换
- **资源释放**：确保摄像头、音频播放器等资源及时释放
- **错误处理**：完善的异常处理，确保功能稳定
- **性能优化**：合理使用Timer和资源管理
- **适配性**：支持不同设备的摄像头配置

### 📝 注意事项
- 需要真实设备测试摄像头功能（模拟器可能不支持）
- 确保添加了所有必要的权限配置
- 使用震动反馈模拟铃声，无需额外音频资源
- 支持前后摄像头切换（需要设备支持）
- 已解决空音频文件导致的崩溃问题 